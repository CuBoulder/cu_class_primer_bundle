<?php

/**
 * @file
 */

/**
 * Implements hook_menu().
 */
function cu_class_primer_bundle_menu() {
  $items['admin/config/system/class-primer'] = array(
    'title' => 'Class Primer',
    'description' =>  'Import classes.',
    'page callback' => 'cu_class_primer_import',
    'access arguments' => array('administer modules'),
  );

  $items['primer/courses'] = array(
    'title' => 'Class Primer - Master XML',
    'description' =>  'Import classes.',
    'page callback' => 'cu_class_primer_master',
    'access callback' => 'cu_class_primer_access',
    'type' => MENU_CALLBACK,
  );

  $items['primer/class'] = array(
    'title' => 'Class Primer - Detail XML',
    'description' =>  'Import classes.',
    'page callback' => 'cu_class_primer_detail',
    'access callback' => 'cu_class_primer_access',
    'type' => MENU_CALLBACK,
  );

  $items['primer/classes/test'] = array(
    'title' => 'Class Primer - Detail XML',
    'description' =>  'Import classes.',
    'page callback' => 'cu_classes_primer_detail',
    'access callback' => 'cu_class_primer_access',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Access callback for ??
 */
function cu_class_primer_access() {
  // switch to a custom permission?
  return TRUE;
}

/**
 * A basic course listing
 */
function cu_class_primer_master($arg2, $arg3, $arg4) {
  drupal_add_http_header('Content-Type', 'text/xml');
  //$inst = 'CUBLD';
  //$term = '2164';
  //$subject = 'HIST';

  $inst = $arg2;
  $term = $arg3;
  $subject = $arg4;

  $output = '<?xml version="1.0" encoding="UTF-8"?>
  <SSR_GET_CLASSES_RESP xmlns="http://xmlns.oracle.com/Enterprise/HCM/services">
    <SEARCH_RESULT>
      <SUBJECTS>';
  $results = db_query('SELECT * FROM {class_search} WHERE SBJCT_CD = :subject', array(':subject' => $subject));


  foreach ($results as $course) {
    //mimic XML structure from master response
    //dsm($course);
    $title = check_plain($course->CRSE_TTL_LD);
    $output .= "
    <SUBJECT>
      <CRSE_ID>$course->CRSE_CD</CRSE_ID>
      <SUBJECT>$course->SBJCT_CD</SUBJECT>
      <CATALOG_NBR>$course->CATALOG_NBR</CATALOG_NBR>
      <ACAD_CAREER>$course->ACAD_CAR_CD</ACAD_CAREER>
      <COURSE_TITLE_LONG>$title</COURSE_TITLE_LONG>
      <CRSE_OFFER_NBR>1</CRSE_OFFER_NBR>
    </SUBJECT>";
  }

  $output .= '</SUBJECTS>
</SEARCH_RESULT>
</SSR_GET_CLASSES_RESP>';

  print $output;
}
/**
 * A detailed class listing
 */
function cu_classes_primer_detail() {
  drupal_add_http_header('Content-Type', 'text/xml');

  $output = '<?xml version="1.0" encoding="UTF-8"?>
<SSR_GET_CLASSES_RESP xmlns="http://xmlns.oracle.com/Enterprise/HCM/services">
  <SEARCH_RESULT>
    <SUBJECTS>
      <SUBJECT>
        <CRSE_ID>123</CRSE_ID>
        <SUBJECT>test</SUBJECT>
        <CATALOG_NBR>123</CATALOG_NBR>
        <ACAD_CAREER>UNGR</ACAD_CAREER>
        <COURSE_TITLE_LONG>testing</COURSE_TITLE_LONG>
        <CRSE_OFFER_NBR>1</CRSE_OFFER_NBR>
      </SUBJECT>
    </SUBJECTS>
  </SEARCH_RESULT>
</SSR_GET_CLASSES_RESP>';

  print $output;
}

/**
 * A detailed class listing
 */
function cu_class_primer_detail($arg2, $arg3, $arg4, $arg5) {
  drupal_add_http_header('Content-Type', 'text/xml');
  //$inst = 'CUBLD';
  //$term = '2164';
  //$subject = 'HIST';

  $inst = $arg2;
  $term = $arg3;
  $subject_cd = $arg4;
  $course_id = $arg5;
  $subject_count = 0;
  $class_count = 0;

  $output = '<?xml version="1.0" encoding="UTF-8"?>
<SSR_GET_CLASSES_RESP xmlns:ser="http://xmlns.oracle.com/Enterprise/HCM/services">
    <SEARCH_RESULT>
    <ERROR_WARN_TEXT/>
    <SSR_COURSE_COUNT>1</SSR_COURSE_COUNT>
    <SSR_ERR_LMT_EXCEED/>
    <SSR_WRN_LMT_EXCEED/>
    <SSR_CLASS_COUNT>1</SSR_CLASS_COUNT>
    <SUBJECTS>';

  $results = db_query('SELECT * FROM {class_search} WHERE CRSE_CD = :course_id', array(':course_id' => $course_id));

  foreach ($results as $subject) {
    //dsm($subject);
    $subject_count++;
    //mimic XML structure from detail response

    $title = check_plain($subject->CRSE_TTL_LD);
    $subject_nbr = str_replace( ',', '', $subject->CLASS_NUM);

    $output .= '<SUBJECT index="' . $subject_count . '">
      <CRSE_ID>' . $course_id  . '</CRSE_ID>
      <CRSE_ID_LOVDescr>' . $title  . '</CRSE_ID_LOVDescr>
      <SUBJECT>' . $subject_cd  . '</SUBJECT>
      <SUBJECT_LOVDescr>' . $subject->SBJCT_LD  . '</SUBJECT_LOVDescr>
      <CATALOG_NBR>' . $subject->CATALOG_NBR  . '</CATALOG_NBR>
      <INSTITUTION>' . $inst  . '</INSTITUTION>
      <INSTITUTION_LOVDescr>CU Boulder</INSTITUTION_LOVDescr>
      <ACAD_CAREER>' . $subject->ACAD_CAR_CD  . '</ACAD_CAREER>
      <ACAD_CAREER_LOVDescr></ACAD_CAREER_LOVDescr>
      <COURSE_TITLE_LONG>' . $title  . '</COURSE_TITLE_LONG>
      <CRSE_OFFER_NBR>1</CRSE_OFFER_NBR>
      <CLASSES_SUMMARY>';

    // class meeting
    $classes = db_query('SELECT * FROM {class_psquery} WHERE CRSE_ID = :course_id', array(':course_id' => $course_id));
    foreach ($classes as $class) {
      $class_count++;
      //clean up times from csv imports tables
      //1/1/1900 9:00:00.000000 AM 
      $time_start = str_replace(":00.000000", "", $class->MEETING_TIME_START);
      $time_start = str_replace("1/1/1900 ", "", $time_start);
      //dsm($time_start);
      
      $time_end = str_replace(":00.000000", "", $class->MEETING_TIME_START);
      $time_end = str_replace("1/1/1900 ", "", $time_end);
      //dsm($time_end);
      
      // build meeting schedule long
      $schedule = '';
      if ($class->Mon) {
        $schedule .= 'Mon';
      }
      if ($class->Tues) {
        $schedule .= 'Tues';
      }
      if ($class->Wed) {
        $schedule .= 'Wed';
      }
      if ($class->Thurs) {
        $schedule .= 'Thurs';
      }
      if ($class->Fri) {
        $schedule .= 'Fri';
      }
      if ($class->Sat) {
        $schedule .= 'Sat';
      }
      if ($class->Sun) {
        $schedule .= 'Sun';
      }
      
      $schedule .= ' ' . $class->MEETING_TIME_START . ' - ' . $class->MEETING_TIME_END;
      
      
      $output .= '      <CLASS_SUMMARY index="' . $class_count. '">
          <CRSE_ID>' . $course_id . '</CRSE_ID>
          <CRSE_ID_LOVDescr>' . $title . '</CRSE_ID_LOVDescr>
          <SUBJECT>' . $subject_cd . '</SUBJECT>
          <SUBJECT_LOVDescr>' . $subject->SBJCT_LD . '</SUBJECT_LOVDescr>
          <CATALOG_NBR>' . $subject->CATALOG_NBR . '</CATALOG_NBR>
          <CRSE_OFFER_NBR>1</CRSE_OFFER_NBR>
          <STRM>' . $term . '</STRM>
          <STRM_LOVDescr>' . $subject->TEM_LD . '</STRM_LOVDescr>
          <SESSION_CODE>' . $subject->SESSION_CD . '</SESSION_CODE>
          <SESSION_CODE_LOVDescr></SESSION_CODE_LOVDescr>
          <CLASS_SECTION>' . $class->CLASS_SECTION . '</CLASS_SECTION>
          <CLASS_NBR>' . $subject_nbr . '</CLASS_NBR>
          <SCHEDULE_PRINT>Y</SCHEDULE_PRINT>
          <SCHEDULE_PRINT_LOVDescr>Yes</SCHEDULE_PRINT_LOVDescr>
          <COMBINED_SECTION/>
          <COMBINED_SECTION_LOVDescr/>
          <STATUS>O</STATUS>
          <CLASS_TOPIC>0</CLASS_TOPIC>
          <SSR_CLASSNAME_LONG/>
          <STATUS>O</STATUS>
          <STATUS_LOVDescr>Open</STATUS_LOVDescr>
          <SSR_COMPONENT>' . $class->CLASS_SECTION . '</SSR_COMPONENT>
          <SSR_COMPONENT_LOVDescr></SSR_COMPONENT_LOVDescr>
          <CAMPUS></CAMPUS>
          <CAMPUS_LOVDescr></CAMPUS_LOVDescr>
          <INSTITUTION>CUBLD</INSTITUTION>
          <SSR_DESCRLONG>' . $class->SSR_DESCRLONG . '</SSR_DESCRLONG>
          <INSTRUCTION_MODE>' . $class->INSTRUCTION_MODE . '</INSTRUCTION_MODE>
          <INSTRUCTION_MODE_LOVDescr></INSTRUCTION_MODE_LOVDescr>
          <ENRL_CAP>' . $subject->ENRL_CAP . '</ENRL_CAP>
          <ENRL_TOT>' . $subject->ENRL_TOT . '</ENRL_TOT>
          <WAIT_CAP>' . $subject->WAIT_CAP . '</WAIT_CAP>
          <WAIT_TOT>' . $subject->WAIT_TOT . '</WAIT_TOT>
          <ENRL_STAT>' . $subject->ENRL_STAT . '</ENRL_STAT>
          <CLASS_NOTES>
            <CLASS_NOTE></CLASS_NOTE>
          </CLASS_NOTES>
          <UNITS_MAX>' . $subject->UNITS_MAXIMUM . '</UNITS_MAX>
          <UNITS_MIN>' . $subject->UNITS_MINIMUM . '</UNITS_MIN>
          <CRSE_ATTR>' . $subject->CRSE_ATTR_CD . '</CRSE_ATTR>
          <CRSE_ATTR_VALUE>' . $subject->CRSE_ATTR_VALUE_CD . '</CRSE_ATTR_VALUE>
          <UNITS_ACAD_PROG>' . $subject->UNITS_ACAD_PROG . '</UNITS_ACAD_PROG>
          <RQRMNT_GROUP></RQRMNT_GROUP>
          <RQRMNT_GROUP_DESCR></RQRMNT_GROUP_DESCR>
          <CRS_TOPIC_ID>0</CRS_TOPIC_ID>
          <CRS_TOPIC_DESCR/>
          <CLASSES_MEETING_PATTERNS>
            <CLASS_MEETING_PATTERN>
              <MEETING_TIME_START>' . $class->MEETING_TIME_START . '</MEETING_TIME_START>
              <MEETING_TIME_END>' . $class->MEETING_TIME_END . '</MEETING_TIME_END>
              <MON>' . $class->Mon . '</MON>
              <TUES>' . $class->Tues . '</TUES>
              <WED>' . $class->Wed . '</WED>
              <THURS>' . $class->Thurs . '</THURS>
              <FRI>' . $class->Fri . '</FRI>
              <SAT>' . $class->Sat . '</SAT>
              <SUN>' . $class->Sun . '</SUN>
              <START_DT>' . $class->START_DT . '</START_DT>
              <END_DT>' . $class->END_DT . '</END_DT>
              <CRS_TOPIC_ID>0</CRS_TOPIC_ID>
              <CRS_TOPIC_ID_LOVDescr/>
              <SCC_LATITUDE>0</SCC_LATITUDE>
              <SCC_LONGITUDE>0</SCC_LONGITUDE>
              <SSR_MTG_SCHED_LONG>' . $schedule . '</SSR_MTG_SCHED_LONG>
              <SSR_MTG_LOC_LONG>' . $class->SSR_MTG_LOC_LONG . '</SSR_MTG_LOC_LONG>
              <SSR_INSTR_LONG>' . $class->SSR_INSTR_LONG . '</SSR_INSTR_LONG>
              <SSR_MTG_DT_LONG>2016-01-19 - 2016-04-29</SSR_MTG_DT_LONG>
              <SSR_TOPIC_LONG>TBA</SSR_TOPIC_LONG>
              <CLASS_INSTRUCTORS>
                <CLASS_INSTRUCTOR>
                  <EMPLID></EMPLID>
                  <INSTR_ROLE>PI</INSTR_ROLE>
                  <INSTR_ROLE_LOVDescr>Primary Instructor</INSTR_ROLE_LOVDescr>
                  <NAME_DISPLAY>' . $class->SSR_INSTR_LONG . '</NAME_DISPLAY>
                  <LAST_NAME></LAST_NAME>
                  <FIRST_NAME></FIRST_NAME>
                  <ENCRYPTED_EMPLID></ENCRYPTED_EMPLID>
                </CLASS_INSTRUCTOR>
              </CLASS_INSTRUCTORS>
            </CLASS_MEETING_PATTERN>
          </CLASSES_MEETING_PATTERNS>
        </CLASS_SUMMARY>';
    }
    $output .= '    </CLASSES_SUMMARY>
    </SUBJECT>';
  }

  $output .= '</SUBJECTS>
</SEARCH_RESULT>
</SSR_GET_CLASSES_RESP>
';

  print $output;
}
